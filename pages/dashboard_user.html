<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>MatchFlow - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><rect width='100%25' height='100%25' fill='%23137fec'/><text x='50%25' y='55%25' font-size='10' text-anchor='middle' fill='%23fff' font-family='Arial'>M</text></svg>">
    <style>
        :root { --primary: #137fec; }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-icon">
                    <span class="material-symbols-outlined">all_inclusive</span>
                </div>
                <div>
                    <h1 class="logo-title">MatchFlow</h1>
                    <p class="logo-subtitle">Crudzaso</p>
                </div>
            </div>

            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" data-view="discovery">
                    <span class="material-symbols-outlined filled">explore</span>
                    <p>Discovery</p>
                </a>
                <a href="#" class="nav-item" data-view="matches">
                    <span class="material-symbols-outlined">favorite</span>
                    <p>My Matches</p>
                    <span class="badge" id="matches-count">0</span>
                </a>
                <a href="#" class="nav-item company-only" data-view="reserved">
                    <span class="material-symbols-outlined">bookmark</span>
                    <p>Reserved</p>
                </a>
                <a href="createOffer.html" class="nav-item company-only">
                    <span class="material-symbols-outlined">add</span>
                    <p>Create Offer</p>
                </a>
                <a href="#" class="nav-item" onclick="logout(); return false;">
                    <span class="material-symbols-outlined">logout</span>
                    <p>Logout</p>
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="profile-card">
                    <img id="user-avatar" class="profile-avatar" src="" alt="User" width="40" height="40">
                    <div class="profile-info">
                        <p class="profile-name" id="user-name">Invitado</p>
                        <p class="profile-role" id="user-role"></p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="header-content">
                    <div class="header-left">
                        <h2 class="header-title-mobile" id="view-title">Discovery</h2>
                        <div class="job-selector">
                            <div class="select-wrapper">
                                <span class="material-symbols-outlined select-icon">work</span>
                                <select class="job-select" id="job-filter">
                                    <option value="all">All Professions</option>
                                </select>
                                <span class="material-symbols-outlined select-arrow">expand_more</span>
                            </div>
                        </div>
                    </div>
                    <div class="header-right">
                        <button class="btn-new-search" id="toggle-view-btn">
                            <span class="material-symbols-outlined">swap_horiz</span>
                            <span id="toggle-text">View Offers</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area">
                <div class="content-header">
                    <div>
                        <div class="status-bar">
                            <span class="status-badge" id="status-badge">Active</span>
                            <span class="dot">â€¢</span>
                            <span class="status-text">Last updated <span id="update-time">now</span></span>
                        </div>
                        <h3 class="page-title" id="page-title">
                            <span id="view-title-main">Candidates</span>
                        </h3>
                        <p class="page-subtitle">
                            Showing <span id="results-count">0</span> results
                        </p>
                    </div>
                    <div class="header-actions">
                        <button class="btn-filter" id="refresh-btn">
                            <span class="material-symbols-outlined">refresh</span>
                            <span>Reload</span>
                        </button>
                    </div>
                </div>

                <!-- Cards Container -->
                <div class="cards-container">
                    <div class="cards-grid" id="cards-grid">
                        <div class="skeleton-card">
                            <div class="loading-skeleton skeleton-avatar"></div>
                            <div class="loading-skeleton skeleton-title"></div>
                            <div class="loading-skeleton skeleton-text"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="actionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://localhost:3000';
        let db = null;
        let currentUser = null;
        let currentView = 'discovery';

        const professions = [
            'Desarrollador Frontend', 'Desarrollador Backend', 'Desarrollador Full Stack',
            'DiseÃ±ador UX/UI', 'Data Analyst'
        ];

        async function init() {
            currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            // Update UI
            document.getElementById('user-name').textContent = currentUser.name || 'Usuario';
            document.getElementById('user-avatar').src = currentUser.avatar || 'https://via.placeholder.com/40?text=%3F';
            document.getElementById('user-role').textContent = currentUser.rol === 'company' ? 'Company' : 'Candidate';

            // Hide company-only nav
            if (currentUser.rol !== 'company') {
                document.querySelectorAll('.company-only').forEach(el => el.style.display = 'none');
            }

            // Load professions
            const select = document.getElementById('job-filter');
            professions.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.textContent = p;
                select.appendChild(opt);
            });

            setupNavigation();
            setupFilters();
            await loadData();
            render();
        }

        async function loadData() {
            try {
                const [candidates, companies, jobOffers, matches] = await Promise.all([
                    fetch(`${API_URL}/candidates`).then(r => r.json()),
                    fetch(`${API_URL}/companies`).then(r => r.json()),
                    fetch(`${API_URL}/jobOffers`).then(r => r.json()),
                    fetch(`${API_URL}/matches`).then(r => r.json())
                ]);
                db = { candidates, companies, jobOffers, matches };
            } catch (e) {
                console.error('Error loading data:', e);
                alert('Error loading data. Make sure json-server is running on port 3000.');
            }
        }

        function setupNavigation() {
            document.querySelectorAll('.nav-item[data-view]').forEach(nav => {
                nav.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    nav.classList.add('active');
                    currentView = nav.dataset.view;
                    render();
                });
            });
        }

        function setupFilters() {
            document.getElementById('job-filter').addEventListener('change', render);
            document.getElementById('refresh-btn').addEventListener('click', async () => {
                await loadData();
                render();
            });
            document.getElementById('toggle-view-btn').addEventListener('click', toggleView);
        }

        function toggleView() {
            const isDiscovery = currentView === 'discovery';
            if (currentUser.rol === 'company') {
                currentView = isDiscovery ? 'offers' : 'discovery';
            } else {
                currentView = isDiscovery ? 'offers' : 'discovery';
            }
            render();
        }

        function render() {
            const grid = document.getElementById('cards-grid');
            const title = document.getElementById('view-title-main');
            const count = document.getElementById('results-count');
            const filter = document.getElementById('job-filter').value;

            let items = [];
            let viewTitle = '';

            switch (currentView) {
                case 'discovery':
                    items = db?.candidates?.filter(c => c.openToWork && (filter === 'all' || c.profession === filter)) || [];
                    viewTitle = 'Candidates';
                    break;
                case 'offers':
                    items = db?.jobOffers?.filter(o => o.isActive && (filter === 'all' || o.profession === filter)) || [];
                    viewTitle = 'Job Offers';
                    break;
                case 'matches':
                    items = currentUser.rol === 'company'
                        ? db?.matches?.filter(m => m.companyId === currentUser.id) || []
                        : db?.matches?.filter(m => m.candidateId === currentUser.id) || [];
                    viewTitle = 'My Matches';
                    break;
                case 'reserved':
                    items = db?.candidates?.filter(c => c.reservedBy === currentUser.id) || [];
                    viewTitle = 'Reserved';
                    break;
            }

            title.textContent = viewTitle;
            count.textContent = items.length;

            if (!items.length) {
                grid.innerHTML = `<div class="text-center text-muted p-5">No ${viewTitle.toLowerCase()} found</div>`;
                return;
            }

            if (currentView === 'matches') {
                grid.innerHTML = items.map(m => {
                    const offer = db.jobOffers.find(o => o.id === m.jobOfferId);
                    const company = db.companies.find(c => c.id === m.companyId);
                    const candidate = db.candidates.find(c => c.id === m.candidateId);
                    return renderMatchCard(m, offer, company, candidate);
                }).join('');
            } else if (currentView === 'offers') {
                grid.innerHTML = items.map(o => {
                    const company = db.companies.find(c => c.id === o.companyId);
                    return renderOfferCard(o, company);
                }).join('');
            } else {
                grid.innerHTML = items.map(c => renderCandidateCard(c)).join('');
            }

            // Update match count
            const matchCount = db?.matches?.filter(m => 
                currentUser.rol === 'company' ? m.companyId === currentUser.id : m.candidateId === currentUser.id
            ).length || 0;
            document.getElementById('matches-count').textContent = matchCount;
        }

        function renderCandidateCard(c) {
            const reserved = c.reservedBy ? 'reserved' : '';
            return `
                <article class="card candidate-card ${reserved}">
                    <div class="card-body">
                        <div class="d-flex align-items-center gap-3 mb-2">
                            <img src="${c.avatar || 'https://via.placeholder.com/48'}" width="48" height="48" class="rounded-circle">
                            <div>
                                <h5 class="mb-0">${c.name}</h5>
                                <small class="text-muted">${c.profession || 'Sin profesiÃ³n'}</small>
                            </div>
                            ${c.openToWork ? '<span class="badge bg-success">Open to Work</span>' : '<span class="badge bg-secondary">Busy</span>'}
                            ${c.reservedBy ? '<span class="badge bg-warning">Reserved</span>' : ''}
                        </div>
                        ${c.bio ? `<p class="small text-muted">${c.bio}</p>` : ''}
                        <div class="d-flex gap-2 mt-2">
                            ${currentUser.rol === 'company' ? `
                                ${c.openToWork && !c.reservedBy ? `
                                    <button class="btn btn-success btn-sm" onclick="createMatch(${c.id})">Match</button>
                                    <button class="btn btn-warning btn-sm" onclick="reserveCandidate(${c.id})">Reserve</button>
                                ` : ''}
                                ${c.reservedBy === currentUser.id ? `
                                    <button class="btn btn-outline-warning btn-sm" onclick="releaseReservation(${c.id})">Release</button>
                                ` : ''}
                            ` : ''}
                            <button class="btn btn-primary btn-sm" onclick="viewProfile(${c.id})">View</button>
                        </div>
                    </div>
                </article>
            `;
        }

        function renderOfferCard(o, company) {
            return `
                <article class="card job-offer-card">
                    <div class="card-body">
                        <h5>${o.title}</h5>
                        <p class="text-muted">${company?.name || 'N/A'}</p>
                        <div class="mb-2">
                            <span class="badge bg-info">${o.profession}</span>
                            <span class="badge bg-secondary">${o.mode}</span>
                            <span class="badge bg-secondary">${o.location}</span>
                        </div>
                        <p class="small">ðŸ’° ${o.salary}</p>
                        <button class="btn btn-primary btn-sm" onclick="viewOffer(${o.id})">View Details</button>
                    </div>
                </article>
            `;
        }

        function renderMatchCard(m, offer, company, candidate) {
            const statusColors = { pending: 'warning', contacted: 'info', interview: 'primary', hired: 'success', discarded: 'danger' };
            return `
                <article class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5>${offer?.title || 'Deleted'}</h5>
                                <p class="text-muted small">${company?.name || ''}</p>
                            </div>
                            <span class="badge bg-${statusColors[m.status]}">${m.status}</span>
                        </div>
                        <p class="small">ðŸ‘¤ ${candidate?.name || 'Deleted'}</p>
                        <p class="small text-muted">ðŸ“… ${new Date(m.createdAt).toLocaleDateString()}</p>
                        <div class="d-flex gap-2 mt-2">
                            ${currentUser.rol === 'company' ? `
                                <button class="btn btn-primary btn-sm" onclick="updateMatchStatus(${m.id}, 'contacted')">Contact</button>
                                <button class="btn btn-success btn-sm" onclick="updateMatchStatus(${m.id}, 'hired')">Hire</button>
                                <button class="btn btn-danger btn-sm" onclick="updateMatchStatus(${m.id}, 'discarded')">Discard</button>
                            ` : ''}
                            <button class="btn btn-outline-primary btn-sm" onclick="viewMatchDetails(${m.id})">Details</button>
                        </div>
                    </div>
                </article>
            `;
        }

        async function createMatch(candidateId) {
            const offer = db.jobOffers.find(o => o.companyId === currentUser.id);
            if (!offer) {
                alert('No offers created. Create an offer first.');
                return;
            }
            const match = { companyId: currentUser.id, candidateId, jobOfferId: offer.id, status: 'pending', createdAt: new Date().toISOString() };
            try {
                await fetch(`${API_URL}/matches`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(match) });
                await loadData();
                render();
                alert('Match created!');
            } catch (e) {
                alert('Error creating match');
            }
        }

        async function reserveCandidate(candidateId) {
            const offer = db.jobOffers.find(o => o.companyId === currentUser.id);
            if (!offer) {
                alert('No offers created. Create an offer first.');
                return;
            }
            try {
                await fetch(`${API_URL}/candidates/${candidateId}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ reservedBy: currentUser.id, reservedForOffer: offer.id }) });
                await loadData();
                render();
                alert('Candidate reserved!');
            } catch (e) {
                alert('Error reserving candidate');
            }
        }

        async function releaseReservation(candidateId) {
            try {
                await fetch(`${API_URL}/candidates/${candidateId}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ reservedBy: null, reservedForOffer: null }) });
                await loadData();
                render();
                alert('Reservation released');
            } catch (e) {
                alert('Error releasing reservation');
            }
        }

        async function updateMatchStatus(matchId, status) {
            try {
                await fetch(`${API_URL}/matches/${matchId}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status }) });
                await loadData();
                render();
            } catch (e) {
                alert('Error updating match');
            }
        }

        function viewProfile(id) {
            window.location.href = `candidate.html?id=${id}`;
        }

        function viewOffer(id) {
            // Just show details in modal
            const offer = db.jobOffers.find(o => o.id === id);
            const company = db.companies.find(c => c.id === offer?.companyId);
            document.getElementById('modalTitle').textContent = offer?.title;
            document.getElementById('modalBody').innerHTML = `
                <p><strong>Company:</strong> ${company?.name || 'N/A'}</p>
                <p><strong>Description:</strong> ${offer?.description || 'N/A'}</p>
                <p><strong>Location:</strong> ${offer?.location}</p>
                <p><strong>Salary:</strong> ${offer?.salary}</p>
            `;
            new bootstrap.Modal(document.getElementById('actionModal')).show();
        }

        function viewMatchDetails(id) {
            const m = db.matches.find(x => x.id === id);
            const offer = db.jobOffers.find(o => o.id === m?.jobOfferId);
            const company = db.companies.find(c => c.id === m?.companyId);
            const candidate = db.candidates.find(c => c.id === m?.candidateId);
            document.getElementById('modalTitle').textContent = 'Match Details';
            document.getElementById('modalBody').innerHTML = `
                <p><strong>Offer:</strong> ${offer?.title || 'N/A'}</p>
                <p><strong>Company:</strong> ${company?.name || 'N/A'}</p>
                <p><strong>Candidate:</strong> ${candidate?.name || 'N/A'}</p>
                <p><strong>Status:</strong> ${m?.status}</p>
                ${m?.status === 'contacted' || m?.status === 'interview' || m?.status === 'hired' ? `<p><strong>Contact:</strong> ${candidate?.phone || 'N/A'}</p>` : ''}
            `;
            new bootstrap.Modal(document.getElementById('actionModal')).show();
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }

        window.logout = logout;
        window.createMatch = createMatch;
        window.reserveCandidate = reserveCandidate;
        window.releaseReservation = releaseReservation;
        window.updateMatchStatus = updateMatchStatus;
        window.viewProfile = viewProfile;
        window.viewOffer = viewOffer;
        window.viewMatchDetails = viewMatchDetails;

        init();
    </script>
</body>
</html>
